#!/bin/bash
set -ex

until pg_isready -h postgres; do
  sleep 1
done

dropdb --if-exists -h postgres -U postgres rubybench
createdb -h postgres -U postgres rubybench

# Setting up ruby-pg"
cd /ruby-pg
git pull --rebase origin master
if [ -n "$PG_COMMIT_HASH" ]; then git reset --hard $PG_COMMIT_HASH; fi
bundle install

# Setting up ruby-bench-suite"
cd /ruby-bench-suite
git pull --rebase origin master

# Installing pg suite bundle"
cd /ruby-bench-suite/pg
bundle install

# Installing before setup bundle"
cd /ruby-bench-suite/support/setup
bundle install --without mysql

if [ "$INCLUDE_PATTERNS" ]; then
  PATTERNS="--pattern $INCLUDE_PATTERNS"
fi

cd /ruby-bench-suite/pg/benchmarks
ruby driver.rb $PATTERNS
